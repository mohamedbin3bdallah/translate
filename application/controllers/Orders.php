<?phpdefined('BASEPATH') OR exit('No direct script access allowed');include('vendor/autoload.php');use ElephantIO\Client;use ElephantIO\Engine\SocketIO\Version2X;class Orders extends CI_Controller {	/**	 * Index Page for this controller.	 *	 * Maps to the following URL	 * 		http://example.com/index.php/welcome	 *	- or -	 * 		http://example.com/index.php/welcome/index	 *	- or -	 * Since this controller is set as the default controller in	 * config/routes.php, it's displayed at http://example.com/	 *	 * So any other public methods not prefixed with an underscore will	 * map to /index.php/welcome/<method_name>	 * @see http://codeigniter.com/user_guide/general/urls.html	 */	function __construct()    {		parent::__construct();		$this->mysystem = $this->Admin_mo->getrow('system',array('id'=>'1'));	    if(!$this->session->userdata('uid'))	    { 			redirect('home');	    }		else		{			$this->loginuser = $this->Admin_mo->getrowjoinLeftLimit('users.*,usertypes.privileges as privileges,langs.dir as dir','users',array('usertypes'=>'users.utid=usertypes.id','langs'=>'users.lang=langs.code'),array('users.id'=>$this->session->userdata('uid')),'');			$this->sections = array();			$sections = $this->Admin_mo->getwhere('sections',array('active'=>'1'));			if(!empty($sections))			{				foreach($sections as $section) { $this->sections[$section->id] = $section->code; }			}		}	}	public function accept()	{		if(isset($_POST['val'],$_POST['id']) && $_POST['val'] > 0 && $_POST['id'] > 0)		{			$order = $this->Admin_mo->getwhere('orders',array('id'=>$_POST['id'],'accept'=>'0'));			if(isset($order) && count($order) == 1)			{				$user = $this->Admin_mo->getrow('users',array('id'=>$_POST['translator'],'active'=>'1'));				if(isset($_POST['translator']) && $_POST['translator'] > 0 && $_POST['val'] == '1' && isset($user) && count($user) == 1)				{					//$code = substr(str_shuffle('0123456789abcdefghijklmnopqrstuvwxyz!@#$%^&*()') , 0 , 15);					if($this->Admin_mo->update('orders',array('accept'=>$_POST['val']),array('id'=>$_POST['id'])))					{						$this->Admin_mo->set('works', array('company'=>$order[0]->user,'translator'=>$_POST['translator'],'lang'=>$order[0]->lang,'file'=>$order[0]->file,'price'=>$order[0]->price,'time'=>time()));						/*$version = new Version2X('http://localhost:3001');						$client = new Client($version);						$client->initialize();						$client->emit('new_notify', ['user'=>$order[0]->user,'message'=>'تم الموافقة على طلبك بترمجة الملف '.$order[0]->file.' الى اللغة '.$order[0]->lang.' والذي سيقوم به المترجم '.$user->username.' ورقم هاتفه '.$user->mobile.' وكوده '.$user->code]);						$client->close();*/						$this->Admin_mo->set('notifications', array('type'=>'order','user'=>$this->session->userdata('uid'),'target'=>$order[0]->user,'action'=>'تم الموافقة على طلبك بترمجة الملف '.$order[0]->file.' الى اللغة '.$order[0]->lang.' والذي سيقوم به المترجم '.$user->username.' ورقم هاتفه '.$user->mobile.' وكوده '.$user->code,'time'=>time()));						echo 1;					}					else echo 0;				}				else				{					if($this->Admin_mo->update('orders',array('accept'=>$_POST['val']),array('id'=>$_POST['id'])))					{						/*$version = new Version2X('http://localhost:3001');						$client = new Client($version);						$client->initialize();						$client->emit('new_notify', ['user'=>$order[0]->user,'message'=>'للاسف تم رفض طلبك بترجمة الملف '.$order[0]->file.' الى اللغة '.$order[0]->lang]);						$client->close();*/						$this->Admin_mo->set('notifications', array('type'=>'order','user'=>$this->session->userdata('uid'),'target'=>$order[0]->user,'action'=>'للاسف تم رفض طلبك بترجمة الملف '.$order[0]->file.' الى اللغة '.$order[0]->lang,'time'=>time()));						echo 2;					}					else echo 0;				}			}			else echo 0;		}		else echo 0;	}		public function company_accept()	{		if(isset($_POST['val'],$_POST['id']) && $_POST['val'] > 0 && $_POST['id'] > 0)		{			$order = $this->Admin_mo->getwhere('companies',array('id'=>$_POST['id'],'accept'=>'0'));			if(isset($order) && count($order) == 1)			{				$user = $this->Admin_mo->getrow('users',array('id'=>$order[0]->translator,'active'=>'1'));				if($_POST['val'] == '1' && isset($user) && count($user) == 1)				{					//$code = substr(str_shuffle('0123456789abcdefghijklmnopqrstuvwxyz!@#$%^&*()') , 0 , 15);					if($this->Admin_mo->update('companies',array('accept'=>$_POST['val'],'time'=>time()),array('id'=>$_POST['id'])))					{						//$this->Admin_mo->set('works', array('company'=>$order[0]->user,'translator'=>$_POST['translator'],'lang'=>$order[0]->lang,'file'=>$order[0]->file,'price'=>$order[0]->price,'time'=>time()));						/*$version = new Version2X('http://localhost:3001');						$client = new Client($version);						$client->initialize();						$client->emit('new_notify', ['user'=>$order[0]->user,'message'=>'تم الموافقة على طلبك بتعيين المترجم '.$user->username.' ورقم هاتفه '.$user->mobile.' وكوده '.$user->code]);						$client->close();*/						$this->Admin_mo->set('notifications', array('type'=>'order','user'=>$this->session->userdata('uid'),'target'=>$order[0]->translator,'action'=>'تم الموافقة على طلبك بتعيين المترجم '.$user->username.' ورقم هاتفه '.$user->mobile.' وكوده '.$user->code,'time'=>time()));						echo 1;					}					else echo 0;				}				else				{					if($this->Admin_mo->update('companies',array('accept'=>$_POST['val'],'time'=>time()),array('id'=>$_POST['id'])))					{						/*$version = new Version2X('http://localhost:3001');						$client = new Client($version);						$client->initialize();						$client->emit('new_notify', ['user'=>$order[0]->user,'message'=>'للاسف تم رفض طلبك بتعيين المترجم '.$user->code]);						$client->close();*/						$this->Admin_mo->set('notifications', array('type'=>'order','user'=>$this->session->userdata('uid'),'target'=>$order[0]->translator,'action'=>'للاسف تم رفض طلبك بتعيين المترجم '.$user->code,'time'=>time()));						echo 2;					}					else echo 0;				}			}			else echo 0;		}		else echo 0;	}}